<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Fibonacci Retracement Analyzer</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>SEO Fibonacci Retracement Analyzer</h1>
            <p>Upload your SEMrush ranking data to discover hidden Fibonacci patterns in your keyword rankings</p>
        </header>

        <section id="file-upload">
            <h2>Step 1: Upload SEMrush CSV</h2>
            <p>Export your historical ranking data from SEMrush (Position Tracking > Rankings Overview) and upload the CSV file below:</p>
            <p><small>The tool supports the wide-format SEMrush export with multiple date columns (*.indsci.com/*_YYYYMMDD format)</small></p>
            <div class="upload-container">
                <input type="file" id="csv-file" accept=".csv">
                <button id="upload-btn">Process Data</button>
            </div>
            <div id="upload-status"></div>
        </section>

        <section id="keyword-selection" style="display: none;">
            <h2>Step 2: Select Keywords</h2>
            <p>The analyzer has identified the following keywords with significant volatility. Select the ones you'd like to analyze:</p>
            <div id="keyword-list-container"></div>
            <button id="analyze-btn">Analyze Selected Keywords</button>
        </section>

        <section id="results" style="display: none;">
            <h2>Fibonacci Analysis Results</h2>
            <div id="charts-container"></div>
            <div id="summary-container"></div>
        </section>
    </div>

    <!-- Load external libraries first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <!-- Load our application code as module -->
    <script type="module">
        // Import directly in this script tag
        import { SEOFibonacciAnalyzer, SEOFibUIController } from './js/analyzer.js';
        import { transformSEMrushData } from './js/semrush-adapter.js';

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const csvFileInput = document.getElementById('csv-file');
            const uploadButton = document.getElementById('upload-btn');
            const uploadStatus = document.getElementById('upload-status');
            const keywordSection = document.getElementById('keyword-selection');
            const keywordListContainer = document.getElementById('keyword-list-container');
            const analyzeButton = document.getElementById('analyze-btn');
            const resultsSection = document.getElementById('results');
            const chartsContainer = document.getElementById('charts-container');
            const summaryContainer = document.getElementById('summary-container');

            // Create instances of our classes
            const analyzer = new SEOFibonacciAnalyzer();
            const uiController = new SEOFibUIController(analyzer);

            // Event listeners
            uploadButton.addEventListener('click', handleFileUpload);
            analyzeButton.addEventListener('click', analyzeSelectedKeywords);

            // Show initial status
            showStatus('Please select a SEMrush CSV file and click "Process Data"', 'info');

            // Handle file upload
            async function handleFileUpload() {
                console.log('File upload button clicked');
                const file = csvFileInput.files[0];
                if (!file) {
                    showStatus('Please select a CSV file first.', 'error');
                    return;
                }

                try {
                    showStatus('<div class="loading-spinner"></div> Processing file... This might take a minute for large datasets.', 'info');
                    
                    // Read the file
                    const fileContent = await readFile(file);
                    console.log('File read successfully, length:', fileContent.length);
                    
                    // Parse the CSV file
                    const parsedResult = Papa.parse(fileContent, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    
                    console.log('CSV parsed, transforming data...');
                    
                    // Transform the complex SEMrush format to the format expected by the analyzer
                    const transformedData = transformSEMrushData(parsedResult.data);
                    
                    if (transformedData.length === 0) {
                        showStatus('No valid data found in the CSV. Make sure you\'re using a SEMrush position tracking export.', 'error');
                        return;
                    }
                    
                    console.log(`Transformed ${transformedData.length} data points`);
                    
                    // Process the transformed data
                    analyzer.processRawData(transformedData);
                    
                    // Calculate volatility to identify keywords for analysis
                    analyzer.calculateVolatility();
                    
                    if (analyzer.volatileKeywords.length === 0) {
                        showStatus('No volatile keywords found in the data. Try uploading a file with more historical data points.', 'error');
                        return;
                    }
                    
                    console.log(`Found ${analyzer.volatileKeywords.length} volatile keywords`);
                    
                    // Render the keyword selection list
                    uiController.renderVolatileKeywordsList(keywordListContainer);
                    
                    // Show the keyword selection section
                    keywordSection.style.display = 'block';
                    
                    showStatus(`Successfully processed ${analyzer.keywords.length} keywords. ${analyzer.volatileKeywords.length} keywords show significant volatility.`, 'success');
                } catch (error) {
                    console.error('Error processing file:', error);
                    showStatus(`Error processing file: ${error.message}`, 'error');
                }
            }

            // Read file content
            function readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        resolve(event.target.result);
                    };
                    
                    reader.onerror = (error) => {
                        reject(error);
                    };
                    
                    reader.readAsText(file);
                });
            }

            // Analyze selected keywords
            function analyzeSelectedKeywords() {
                // Get selected keywords
                const selectedKeywords = uiController.getSelectedKeywords();
                
                if (selectedKeywords.length === 0) {
                    showStatus('Please select at least one keyword to analyze.', 'error');
                    return;
                }
                
                // Clear previous results
                chartsContainer.innerHTML = '';
                summaryContainer.innerHTML = '';
                
                // Create a summary table
                const summaryTable = document.createElement('table');
                summaryTable.className = 'keyword-table';
                summaryTable.innerHTML = `
                    <tr>
                        <th>Keyword</th>
                        <th>Volatility Score</th>
                        <th>Fibonacci Reliability</th>
                        <th>Next Support/Resistance</th>
                        <th>Current Trend</th>
                    </tr>
                `;
                
                // Process each selected keyword
                selectedKeywords.forEach(keyword => {
                    // Create a chart container for this keyword
                    const chartCard = document.createElement('div');
                    chartCard.className = 'chart-card';
                    
                    const chartHeader = document.createElement('div');
                    chartHeader.className = 'chart-header';
                    
                    const chartTitle = document.createElement('div');
                    chartTitle.className = 'chart-title';
                    chartTitle.textContent = keyword;
                    
                    chartHeader.appendChild(chartTitle);
                    chartCard.appendChild(chartHeader);
                    
                    // Create canvas for chart
                    const chartCanvas = document.createElement('canvas');
                    chartCanvas.height = 300;
                    chartCard.appendChild(chartCanvas);
                    
                    chartsContainer.appendChild(chartCard);
                    
                    // Render chart
                    uiController.renderFibonacciChart(keyword, chartCanvas);
                    
                    // Add row to summary table
                    const keywordData = analyzer.keywords.find(k => k.keyword === keyword);
                    const reliability = analyzer.calculateFibonacciReliability(keyword);
                    const prediction = analyzer.predictNextRanking(keyword);
                    
                    // Get current position and trend
                    const positions = keywordData.positions;
                    const currentPosition = positions[positions.length - 1].position;
                    const previousPosition = positions.length > 1 ? positions[positions.length - 2].position : currentPosition;
                    const trendDirection = currentPosition < previousPosition ? 'Improving' : 'Declining';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${keyword}</td>
                        <td>${keywordData.volatilityScore.toFixed(2)}</td>
                        <td>${reliability.toFixed(2)}%</td>
                        <td>${prediction ? `${prediction.value.toFixed(2)} (${prediction.level * 100}%)` : 'N/A'}</td>
                        <td>${trendDirection}</td>
                    `;
                    summaryTable.appendChild(row);
                });
                
                summaryContainer.appendChild(summaryTable);
                
                // Show results section
                resultsSection.style.display = 'block';
            }

            // Show status message
            function showStatus(message, type) {
                uploadStatus.innerHTML = message;
                uploadStatus.className = '';
                
                if (type === 'error') {
                    uploadStatus.classList.add('status-error');
                } else if (type === 'success') {
                    uploadStatus.classList.add('status-success');
                } else {
                    uploadStatus.classList.add('status-info');
                }
            }
        });
    </script>
</body>
</html>
